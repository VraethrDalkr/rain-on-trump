<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Is It Raining on Trump?</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    body{margin:0;display:flex;flex-direction:column;
         justify-content:center;align-items:center;height:100vh;
         font-family:system-ui,sans-serif;text-align:center}
    #answer{font-size:6rem}
    #loc{margin-top:.5rem;color:#555}
  </style>
</head>
<body>
  <div id="answer">â€¦</div>
  <div id="loc"></div>

<script>
// ðŸ”§ Your backend API endpoint
const ENDPOINT = "http://192.168.18.11:8000/is_it_raining.json";
// ðŸ”§ Public VAPID key generated with `npx web-push generate-vapid-keys`
const VAPID_PUBLIC = "BO67EcPl8JyHtvhvm04cdf_jMgkXVQBT1uRX9BiljiIxTBH4PpYH0BxsU3BEglva1_iqnqH3T9bVVIj9MI3ZQIE";

function url64ToUint8Array(b64) {
  const pad = "=".repeat((4 - b64.length % 4) % 4);
  const str = (b64 + pad).replace(/-/g, "+").replace(/_/g, "/");
  return Uint8Array.from(atob(str), c => c.charCodeAt(0));
}

async function refresh(){
  try{
    const {raining,location}=await (await fetch(ENDPOINT)).json();
    document.getElementById('answer').textContent=raining?'ðŸŒ§ï¸ YES':'â˜€ï¸ NO';
    document.getElementById('loc').textContent=location;
  }catch(e){
    document.getElementById('answer').textContent='ðŸ¤·';
    document.getElementById('loc').textContent='(error)';
  }
}
refresh(); setInterval(refresh,60_000);

// 1ï¸âƒ£  Register the serviceâ€‘worker, then initialise push
navigator.serviceWorker.register('sw.js')
  .then(() => initPush())
  .catch(console.error);

async function initPush(){
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
  if (Notification.permission === 'denied') return; // user permanently blocked

  const reg = await navigator.serviceWorker.ready;

  // Ask permission if not already granted
  if (Notification.permission !== 'granted') {
    const perm = await Notification.requestPermission();
    if (perm !== 'granted') return; // user said no
  }

  // Existing subscription or create new
  let sub = await reg.pushManager.getSubscription();
  if (!sub) {
    sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: url64ToUint8Array(VAPID_PUBLIC)
    });
  }

  // Send subscription to backend
  try{
    await fetch("http://192.168.18.11:8000/subscribe",{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(sub)
    });
  }catch(err){
    console.error('Failed to register push subscription:',err);
  }
}
</script>
</body>
</html>
